<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hashprng">
<title>Hash-based Matched Pseudo-Random Number Generation • hashprng</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Hash-based Matched Pseudo-Random Number Generation">
<meta property="og:description" content="hashprng">
<meta property="og:image" content="hashprng.epinowcast.org/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hashprng</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.3.0.1000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/hashprng.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Hash-based Matched Pseudo-Random Number Generation</h1>
            
      
      
      <div class="d-none name"><code>hashprng.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates the practical use of
<code><a href="../reference/hash_seed.html">hashprng::hash_seed</a></code>; if you want a detailed explanation of
<em>why</em> to use this approach, read the paper associated with the
package citation: (TODO).</p>
<p>Briefly, hash-based matched pseudo-random number generation
(HBM-PRNG) can ensure that the same “events” across different simulation
scenarios are resolved consistently, while also still permitting
stochastic simulation, and incurring minimal additional computational
overhead. Matched samples can then be analyzed pair-wise, leading to
higher resolution calculation of the overall impact of the
cross-scenario varying features.</p>
<p>However, researchers still need to specify what constitutes “the
same” event, both in terms of what features are hashed and how they
implement the model structure. In this vignette, we focus on how to use
<code><a href="../reference/hash_seed.html">hashprng::hash_seed</a></code>, but do so using two different
implementations of the same model world and two different definitions of
“same” for events.</p>
</div>
<div class="section level2">
<h2 id="standards-of-matching">Standards of Matching<a class="anchor" aria-label="anchor" href="#standards-of-matching"></a>
</h2>
<p>Throughout this vignette we consider a few matching regimes:</p>
<ul>
<li>Non-matched (NON): this is equivalent to drawing an item from this
random process and then one from the same-but-slightly-perturbed process
and comparing them. Note: this kind of simulation should still be
seeded, to ensure reproducibile PRNG.</li>
<li>Seed-Matched-Only (SMO): this scheme ensures that compared runs both
have the same PRNG seeding. This can guarantee, for example, that the
history leading up to an intervention is the same. However, generally
once simulation trajectory diverges, the PRNG is exercised differently,
and events that <em>should</em> be the same between runs are not
guaranteed to see the same PRNG draws.</li>
<li>Fully-Event-Matched (FEM): this scheme ensures that compared runs
have all of their identical events resolved consistently. Any event
which occurs in both simulations gets the same draw from the PRNG.</li>
</ul>
<p>Hash-based matched (HBM) PRNG is an approach to acheiving FEM
simulations. There are alternatives, for example managing multiple PRNGs
or precomputing all possible outcomes. In general, HBM imposes a
guaranteed-but-low computational cost, scaling with the number of the
PRNG draws in any given simulation, with minimal implementation burden
on the modeller.</p>
<p>We’ll be making comparisons across NON, SMO, and HBM in terms of
implementation, compute cost, and calculation resolution.</p>
</div>
<div class="section level2">
<h2 id="model-world-and-scenario">Model World and Scenario<a class="anchor" aria-label="anchor" href="#model-world-and-scenario"></a>
</h2>
<p>We’ll be considering an infectious disease system of the
<em>S</em>usceptible-<em>I</em>nfectious- <em>R</em>emoved variety and
an intervention where, after some delay from initial infection
introduction, a portion of the population are spontaneously moved to
<em>R</em> (representing e.g. a reactive vaccination campaign).</p>
</div>
<div class="section level2">
<h2 id="model-implementation">Model Implementation<a class="anchor" aria-label="anchor" href="#model-implementation"></a>
</h2>
<p>We’ll implement this model in terms of discrete time steps, discrete
individuals, and event probabilities. At each time step:</p>
<ol style="list-style-type: decimal">
<li>We’ll consider if infectious individuals have exposing contact with
susceptible individuals - this converts <em>S</em> to <em>I</em> at the
end of the step.</li>
<li>We’ll consider if infectious individuals recover - <em>I</em> to
<em>R</em>.</li>
<li>If it’s time for the move, we’ll consider which susceptible
individuals to remove - <em>S</em> to <em>R</em>.</li>
</ol>
<p>This is essentially a perturbation to the classic Reed-Frost model,
with the modification that people may be infectious for more than a
single time step ( as well as introducing an intervention).</p>
<p>We’re also going to implement this model two ways, each with a switch
for whether or not to use hash-based matching for the random number
draws. We’ll flip this switch to show matching-vs-not changes
conclusions comparing across scenarios, as well as to measure the
resource cost associated with the higher resolution measurement. We’ll
also create a setup where the seed is only set once for the NON
comparison.</p>
<p>The other element we need to finally specify the model is what
constitutes an event. We’re going to offer two definitions and explore
the consequences. Those two definitions hinge on whether the model’s
discrete individuals have <em>identity</em> or not.</p>
<p>If individuals have identity, then events are distinguished by
<em>who</em> is involved. If they do not, then events are only
distinguished by <em>what</em> and <em>when</em>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define some variables to differentiate between individual states</span></span>
<span><span class="co"># for the non-identity model, these will be compartment indices</span></span>
<span><span class="co"># for the identity model, these are individual states</span></span>
<span><span class="va">susceptible</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span><span class="va">infectious</span> <span class="op">&lt;-</span> <span class="fl">2L</span></span>
<span><span class="va">removed</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span></code></pre></div>
<div class="section level3">
<h3 id="non-identity-model-implementation">Non-Identity Model Implementation<a class="anchor" aria-label="anchor" href="#non-identity-model-implementation"></a>
</h3>
<p>For the non-identity model, we assume that at each time step only the
<em>size</em> of the relative populations should determine event
outcomes, e.g. how many people are infected. We can accomplish that by
drawing from the binomial distribution.</p>
<p>For HBM, we need to match time and event. But since there are (at
most) three draws per step, always occurring in the same order, we can
simply match on time and then quantile draws. We are assuming here that
<code>runif</code> always advances underlying PRNG state by the number
of deviates requested, but that <code>rbinom</code> might advance state
by a variable amount depending on both parameters and state, hence the
need to draw quantiles and then invert to outcomes.</p>
<p>N.B. <code><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">?rbinom</a></code> indicates draws are done per
“Kachitvichyanukul, V. and Schmeiser, B. W. (1988) Binomial random
variate generation. Communications of the ACM, 31, 216–222”, which
describes and algorithm BPTE which does indeed draw uniform deviates a
variable number of times per binomial draw, depending on the <span class="math inline">\(n\)</span> and <span class="math inline">\(p\)</span> arguments.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @param t an integer scalar, the simulation time</span></span>
<span><span class="co">#' @param y an integer vector, the current counts of individuals in S, I, and R</span></span>
<span><span class="co">#' @param parameters a list, `transmission_p`, `recovery_p`, `vaccination_p`,</span></span>
<span><span class="co">#'   and `vax_t`</span></span>
<span><span class="co">#' @param seed optional; if non-null, using HBM</span></span>
<span><span class="va">nonidentity_dStep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">y</span>, <span class="va">parameters</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="op">{</span></span>
<span>    <span class="co"># extract the S, I population counts</span></span>
<span>    <span class="va">Ninf</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">infectious</span><span class="op">]</span></span>
<span>    <span class="va">Nsus</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">susceptible</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># if we are matching events</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># draw the same quantiles for each when</span></span>
<span>      <span class="fu"><a href="../reference/hash_seed.html">hash_seed</a></span><span class="op">(</span><span class="va">seed</span>, <span class="va">t</span><span class="op">)</span></span>
<span>      <span class="va">evtqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="co"># convert these to the outcomes</span></span>
<span>      <span class="va">newinf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="va">evtqs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">Nsus</span>, <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">transmission_p</span><span class="op">)</span><span class="op">^</span><span class="va">Ninf</span><span class="op">)</span></span>
<span>      <span class="va">newrem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="va">evtqs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">Ninf</span>, <span class="va">recovery_p</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span> <span class="co"># simply make the binomial draws</span></span>
<span>      <span class="va">newinf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">Nsus</span>, <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">transmission_p</span><span class="op">)</span><span class="op">^</span><span class="va">Ninf</span><span class="op">)</span></span>
<span>      <span class="va">newrem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">Ninf</span>, <span class="va">recovery_p</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># move infectees S -&gt; I, recoveries I -&gt; R</span></span>
<span>    <span class="va">dY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="op">-</span><span class="va">newinf</span>, I <span class="op">=</span> <span class="va">newinf</span> <span class="op">-</span> <span class="va">newrem</span>, R <span class="op">=</span> <span class="va">newrem</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">==</span> <span class="va">vax_t</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># n.b. still on a consistent PRNG state for this time, so can just draw</span></span>
<span>        <span class="va">newvax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="va">Nsus</span> <span class="op">-</span> <span class="va">newinf</span>, <span class="va">vaccination_p</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">newvax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">Nsus</span> <span class="op">-</span> <span class="va">newinf</span>, <span class="va">vaccination_p</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="co"># move vaccinees</span></span>
<span>      <span class="va">dY</span><span class="op">[</span><span class="va">susceptible</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dY</span><span class="op">[</span><span class="va">susceptible</span><span class="op">]</span> <span class="op">-</span> <span class="va">newvax</span></span>
<span>      <span class="va">dY</span><span class="op">[</span><span class="va">removed</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dY</span><span class="op">[</span><span class="va">removed</span><span class="op">]</span> <span class="op">+</span> <span class="va">newvax</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># return the overall state change, as well as new incidence</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dY</span>, <span class="va">newinf</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="higher-resolution-implementation">Higher Resolution Implementation<a class="anchor" aria-label="anchor" href="#higher-resolution-implementation"></a>
</h3>
<p>For the identity based model, we assume who <em>particularly</em>
gets infected or vaccinated matters. Thus, for HBM we need to hash both
<em>who</em> and <em>when</em> for infection and recovery. We can again
take advantage of a consistent number of draws (because we always
consider exposing all individuals, susceptible or not) to avoid reseting
the PRNG for the recovery draw.</p>
<p>We also set the PRNG for vaccination. This probably isn’t necessary:
vaccination is itself the only factor that might change trajectories, so
there are no differences in trajectory prior to considering vaccination.
However, this is a very fragile arrangement. Adding any other
interventions or otherwise perturbing model assumptions could easily
change traversal of the PRNG and result in unmatched vaccinee
selection.</p>
<p>N.B., for both the matched and unmatched versions we’re generally
overdrawing on random number deviates. While it might be possible to
reduce computational time with fewer draws, that would entail either
other computational work (e.g. calculating who is eligible for
infection) or more convoluted data structures. Those would be plausible
for the unmatched version, at this model complexity, but likely become
less practical with increasing complexity.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @param t an integer scalar, the simulation time</span></span>
<span><span class="co">#' @param y an integer vector, the individual states: S, I, R</span></span>
<span><span class="co">#' @param parameters a list, `transmission_p`, `recovery_p`, `vaccination_p`,</span></span>
<span><span class="co">#'   and `vax_t`</span></span>
<span><span class="co">#' @param salt an integer scalar, optional; if present, use hash-based matching</span></span>
<span><span class="va">identity_dStep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">y</span>, <span class="va">parameters</span>, <span class="va">salt</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="op">{</span></span>
<span>    <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>    <span class="va">dY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>    <span class="va">incI</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="co"># consider whether each infectious individual exposes susceptible</span></span>
<span>    <span class="co"># individuals</span></span>
<span>    <span class="va">infectable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="va">susceptible</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">infector</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="va">infectious</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">infectable</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">salt</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="co"># if HBM, need to reseed RNG for each pair =&gt; draw</span></span>
<span>          <span class="co"># easier to salt =&gt; draw all possible =&gt; slice relevant</span></span>
<span>          <span class="fu"><a href="../reference/hash_seed.html">hash_seed</a></span><span class="op">(</span><span class="va">salt</span>, <span class="st">"inf"</span>, <span class="va">infector</span>, <span class="va">t</span><span class="op">)</span></span>
<span>          <span class="va">infectees</span> <span class="op">&lt;-</span> <span class="va">infectable</span><span class="op">[</span></span>
<span>            <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">infectable</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">transmission_p</span><span class="op">)</span><span class="op">[</span><span class="va">infectable</span><span class="op">]</span></span>
<span>          <span class="op">]</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="va">infectees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>            <span class="va">infectable</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">infectable</span><span class="op">)</span>, <span class="va">transmission_p</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">dY</span><span class="op">[</span><span class="va">infectees</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>        <span class="va">infectable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">infectable</span>, <span class="va">infectees</span><span class="op">)</span></span>
<span>        <span class="co"># if this infector would recovery, indicate 2 =&gt; 3 transition</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">recovery_p</span><span class="op">)</span> <span class="va">dY</span><span class="op">[</span><span class="va">infector</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">incI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">dY</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">y</span> <span class="op">!=</span> <span class="va">infectious</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># if its time for vaccination</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">==</span> <span class="va">vax_t</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">salt</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># if HBM, need to reseed for each individual</span></span>
<span>        <span class="co"># include the t here - what if the model changed vax_t?</span></span>
<span>        <span class="va">psalt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash_seed.html">hash_seed</a></span><span class="op">(</span><span class="va">salt</span>, <span class="st">"vax"</span>, <span class="va">t</span><span class="op">)</span></span>
<span>        <span class="va">vaccinees</span> <span class="op">&lt;-</span> <span class="va">infectable</span><span class="op">[</span></span>
<span>          <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">infectable</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">vaccination_p</span><span class="op">)</span><span class="op">[</span><span class="va">infectable</span><span class="op">]</span></span>
<span>        <span class="op">]</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">vaccinees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>          <span class="va">infectable</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">infectable</span><span class="op">)</span>, <span class="va">vaccination_p</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="co"># for people still susceptible, indicate 1 =&gt; 3 transition</span></span>
<span>      <span class="va">dY</span><span class="op">[</span><span class="va">vaccinees</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dY</span>, <span class="va">incI</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparison">Comparison<a class="anchor" aria-label="anchor" href="#comparison"></a>
</h2>
<p>Let’s run these simulation for a population of 4000 individuals, 75
time steps, and 500 samples. We’ll consider a very small amount of
vaccination - only 3.3%. We want to assess the cumulative averted
<em>incidence</em> of this scenario compared to no vaccination.</p>
<p>For the “non-matching” version, we will still match on random number
seeds; we refer to that as seed-matched-only, or SMO. Because our model
starts vaccination after some delay, we should still see absolutely
identical outcomes for SMO up to that point. However, after that point,
the RNG will see a different traversal.</p>
<p>We’re going to discard outcomes were the epidemic dies out prior to
vaccination. This is a debate-worthy choice - e.g. if we want to
understand the potential benefit of purchasing some program, that should
include the possibility that it was unnecessary. For this model world,
however, those sort of considerations apply equally to either HBM or
SMO, and we want to focus on the ability to resolve intervention impact
when there is an epidemic. Hence, we discard those outcomes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setup parameters</span></span>
<span><span class="va">samplen</span> <span class="op">&lt;-</span> <span class="fl">500L</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fl">4000L</span></span>
<span><span class="va">maxt</span> <span class="op">&lt;-</span> <span class="fl">75L</span></span>
<span><span class="va">initI</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  transmission_p <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.78</span> <span class="op">/</span> <span class="va">pop</span><span class="op">)</span>,</span>
<span>  <span class="co"># ~ 0.78 infections produced per day in fully susceptible pop</span></span>
<span>  recovery_p <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.44</span><span class="op">)</span> <span class="co"># ~ 2.3 days infectious</span></span>
<span>  <span class="co"># implies R0 ~ 1.8</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># non-intervention, set vax_t &lt; 0</span></span>
<span><span class="va">nonps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ps</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  vax_t <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, vaccination_p <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># intervention, vax_t == 10, 3.3% chance to happen</span></span>
<span><span class="va">intps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ps</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  vax_t <span class="op">=</span> <span class="fl">10</span>, vaccination_p <span class="op">=</span> <span class="fl">0.033</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># create populations</span></span>
<span><span class="va">yinit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep.int</a></span><span class="op">(</span><span class="va">susceptible</span>, <span class="va">pop</span><span class="op">)</span></span>
<span><span class="va">yinit</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">initI</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">infectious</span></span>
<span><span class="va">yinit_nonid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop</span> <span class="op">-</span> <span class="va">initI</span>, <span class="va">initI</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stepper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">maxtime</span> <span class="op">=</span> <span class="va">maxt</span>, <span class="va">y0</span>,</span>
<span>    <span class="va">dFUN</span>, <span class="va">pars</span>, <span class="va">seed</span>, <span class="va">HBM</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># if not HBM &amp; a seed provided =&gt; SMO =&gt; set initial seeding</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">HBM</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># reserve data structure</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="va">maxtime</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y0</span></span>
<span>  <span class="co"># run the simulation</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">maxtime</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dY</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">HBM</span><span class="op">)</span> <span class="fu">dFUN</span><span class="op">(</span><span class="va">i</span>, <span class="va">y</span>, <span class="va">pars</span>, <span class="va">seed</span><span class="op">)</span> <span class="kw">else</span> <span class="fu">dFUN</span><span class="op">(</span><span class="va">i</span>, <span class="va">y</span>, <span class="va">pars</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">+</span> <span class="va">dY</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">res</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">dY</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sampling">Sampling<a class="anchor" aria-label="anchor" href="#sampling"></a>
</h2>
<p>Now we run all the samples, using plain sample ID as the SMO seed or
HBM salt, for all the models.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">8675309</span><span class="op">)</span></span>
<span><span class="va">nonid_no_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">ni_non_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"NON"</span>, model <span class="op">=</span> <span class="st">"nonID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">8675309</span><span class="op">)</span></span>
<span><span class="va">id_no_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">wi_non_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"NON"</span>, model <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nonid_seed_match_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">ni_smo_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"SMO"</span>, model <span class="op">=</span> <span class="st">"nonID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">id_seed_match_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">wi_smo_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"SMO"</span>, model <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nonid_hash_based_matching</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">ni_hbm_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">mclapply</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"HBM"</span>, model <span class="op">=</span> <span class="st">"nonID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit_nonid</span>, dFUN <span class="op">=</span> <span class="va">nonidentity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">id_hash_based_matching</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">wi_hbm_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">samplen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">mclapply</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"HBM"</span>, model <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>      not_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">nonps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">)</span>,</span>
<span>      withi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu">stepper</span><span class="op">(</span></span>
<span>        y0 <span class="op">=</span> <span class="va">yinit</span>, dFUN <span class="op">=</span> <span class="va">identity_dStep</span>, pars <span class="op">=</span> <span class="va">intps</span>, seed <span class="op">=</span> <span class="va">seed</span>, HBM <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sampledt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">ni_non_dt</span>, <span class="va">wi_non_dt</span>, <span class="va">ni_smo_dt</span>, <span class="va">wi_smo_dt</span>, <span class="va">ni_hbm_dt</span>, <span class="va">wi_hbm_dt</span><span class="op">)</span></span></code></pre></div>
<p>Timings:</p>
<p>Now we compute the difference in series, and determine if there are
any to drop:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampledt</span><span class="op">[</span>, <span class="va">averted</span> <span class="op">:=</span> <span class="va">not_i</span> <span class="op">-</span> <span class="va">withi</span><span class="op">]</span></span>
<span><span class="va">sampledt</span><span class="op">[</span>, <span class="va">time</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">type</span>, <span class="va">model</span>, <span class="va">sample</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">keepers</span> <span class="op">&lt;-</span> <span class="va">sampledt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>keep <span class="op">=</span> <span class="va">not_i</span><span class="op">[</span><span class="va">intps</span><span class="op">$</span><span class="va">vax_t</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span> <span class="op">!=</span> <span class="va">not_i</span><span class="op">[</span><span class="va">.N</span><span class="op">]</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">type</span>, <span class="va">model</span>, <span class="va">sample</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">keepers</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">keep</span><span class="op">)</span> <span class="op">/</span> <span class="va">.N</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">model</span>, <span class="va">type</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">reduced_dt</span> <span class="op">&lt;-</span> <span class="va">sampledt</span><span class="op">[</span><span class="va">keepers</span>, on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">type</span>, <span class="va">model</span>, <span class="va">sample</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="va">keep</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="va">qtiled_dt</span> <span class="op">&lt;-</span> <span class="va">reduced_dt</span><span class="op">[</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">qs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">averted</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">.</span><span class="op">(</span>lo <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, md <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, hi <span class="op">=</span> <span class="va">qs</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">type</span>, <span class="va">model</span>, <span class="va">time</span><span class="op">)</span></span>
<span><span class="op">]</span></span></code></pre></div>
<p>… and lastly, we should visualize these</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Carl Pearson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
